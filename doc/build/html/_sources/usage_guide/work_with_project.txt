Работа с проектом
=================

Данный раздел отражает основные приемы работы в среде разработки
Beremiz, необходимые при создании прикладной программы. Прикладная
программа для целевой платформы является результатом сборки проекта с
определенной конфигурацией.

Проект в Beremiz представляет собой именованную папку, в которой лежат
исходные файлы. Папка должна быть обязательно пустой и не защищена от
записи. Если в папке уже есть файлы, будет выдана соответствующая
ошибка. В созданной папке будут сохранены следующие файлы и папки:

-  «beremiz.xml» – в данном XML файле сохраняются настройки специфичные
   для среды разработки Beremiz относительно проекта;

-  «plc.xml» – в данном XML файле сохраняется полное описание проекта:
   всех программных модулей, ресурсов, пользовательских типов данных,
   данных о проекте, настроек редакторов графических языков IEC 61131-3;

-  папка «build», которая хранит генерируемый ST и C код, а также
   получаемый исполняемый бинарный файл прошивки.

Создание нового проекта
-----------------------

Новый проект создаётся с помощью главного меню «Файл» – «Новый» 
(см. :numref:`image144`), либо с помощью кнопки «Новый» 
на панели управления.

.. figure:: ./media/image144.png
   :name: image144
   :align: center
   :figclass: align-center
   :width: 2.71875in
   :height: 3.65812in

   \- Создание нового проекта с помощью главного меню

Далее появится диалог (см. :numref:`image145`) , в котором необходимо выбрать
папку, где будет храниться данный проект.

.. figure:: ./media/image145.png
   :name: image145
   :align: center
   :figclass: align-center
   :width: 5.55208in
   :height: 3.65973in

   \- Диалог выбора папки для нового проекта

В появившемся диалоге вам будет предложено настроить основной
программный модуль проекта (см. :numref:`image146`). В данном диалоге три поля:

-  «Имя POU»;

-  «Тип POU»;

-  «Язык».

.. figure:: ./media/image146.png
   :name: image146
   :align: center
   :figclass: align-center
   :width: 1.95247in
   :height: 2.80208in

   \- Диалог добавления основного программного модуля

Имя программного модуля, присвоенное по умолчанию, может быть заменено
на любое имя, соответствующее назначению данного программного модуля.

Тип основного программного модуля – «Программа», в дальнейшем в проект
можно добавить дополнительные программные модули, функции и
функциональные блоки.

В поле «Язык» необходимо выбрать из списка один из языков стандарта IEC
61131-3 (IL, ST, LD, FBD, SFC), на котором будут реализованы алгоритмы и
логика работы данного добавляемого программного модуля.

При нажатии кнопки ОК в проект будет добавлен основной программный
модуль с выбранными параметрами, ресурс проекта будет конфигурирован по
умолчанию: добавлена одна задача циклического выполнения с интервалом 20
мс, и один экземпляр основной программы. При нажатии кнопки
Отмена будет создан пустой проект без каких-либо настроек.

В рамках описания процесса создания нового проекта за основу выбран
проект «First steps» из стандартного набора тестовых проектов IDE
Beremiz. Основной программный модуль в этом проекте написан на языке
FBD, соответственно, в диалоге необходимо выбрать язык FBD, в дальнейшем
язык основного программного модуля возможно изменить.


Настройка проекта
-----------------

Следующим шагом после создания проекта является его настройка,
включающая в себя задание глобальных переменных, установку параметров
компиляции и компоновки, и заполнение данных о проекте.

Вызов панели настройки проекта осуществляется при выборе (двойном щелчке
левой кнопкой мыши) корневого элемента дерева проекта, который по
умолчанию, сразу после создания проекта называется «Unnamed»(см. :numref:`image147`).

.. figure:: ./media/image147.png
   :name: image147
   :align: center
   :figclass: align-center
   :width: 6.26597in
   :height: 2.92948in

   \- Панель настройки проекта

На панели присутствуют три вкладки:

-  Конфигурационные переменные;

-  Свойства проекта;

-  Конфигурация.

-----------------------------------
Конфигурационные переменные проекта
-----------------------------------

Конфигурационные переменные позволяют программным модулям типа
«Программа» и «Функциональный блок» использовать общие переменные,
которые будут определены в глобальной области видимости проекта.

Ниже, на :numref:`image149`, в панели переменных и констант добавим
конфигурационную константу «ResetCounterValue» типа INT с начальным
значением 17, с помощью кнопки «Добавить переменную» (см. таблицу 3).

.. figure:: ./media/image149.png
   :name: image149
   :align: center
   :figclass: align-center
   :width: 7.51597in
   :height: 1.92014in

   \- Объявление конфигурационной переменной

Для того чтобы к данной конфигурационной переменной можно было
обращаться из программных модулей типа «Программа» или «Функциональный
блок» необходимо в их панели редактирования в панели переменных и
констант создать переменную с таким же именем, как и ранее объявленная
глобальная, и установить её класс «Внешний».

-----------------------------------------------------------
Настройки сборки проекта и соединения с целевым устройством
-----------------------------------------------------------

Для использования написанной прикладной программы необходимо её собрать
(скомпилировать и скомпоновать), т.е. получить исполняемый файл и
передать на целевое устройство для отладки или просто исполнения. В
связи с этим основными настройками являются: «URI системы исполнения» -
адрес целевого устройства, и целевая платформа - архитектура платформы
целевого устройства (см. :numref:`image150`).

.. figure:: ./media/image150.png
   :name: image150
   :align: center
   :figclass: align-center
   :width: 4.30208in
   :height: 4.4905in

   \- Конфигурация проекта

Как правило, «URI системы исполнения» указывается в формате:

<Тип коннектора>)://<Адрес последовательного порта
подключения>:<битрейт>

Тип коннектора выбирается в зависимости от типа сервиса подключения к
целевому устройству. Например, для отладки прикладной программы на
локальной машине при помощи Soft PLC, целевым устройством является
служба «Beremiz service» и тип коннектора следует выбрать «LOCAL». Для
отладки прикладной программы вне локальной машины используется
библиотека PYRO, в это случае «URI целевого устройства» указывается в
формате:

PYRO://<IP-адрес целевого устройства>:<порт>

Если в проекте используются дополнительные библиотеки, их следует
добавить в конфигурации проекта, нажав «checkbox» напротив добавляемой
библиотеки в подменю «Библиотеки».

----------------
Данные о проекте
----------------

При создании нового проекта, все обязательные поля в настройках
информации о проекте заполняются значениями по умолчанию. Рекомендуется
заменить данные настройки по умолчанию на релевантную информацию 
(см.:numref:`image152`), позволяющую удобным образом различать проекты.

.. figure:: ./media/image152.png
   :name: image152
   :align: center
   :figclass: align-center
   :width: 4.70833in
   :height: 3.91046in

   \- Заполнение данных о проекте

Большая часть данных в информации проекте являются необязательным для
заполнения, но обязательные должны быть заполнены, такие поля помечены в
подсказках в именовании каждого пункта. После задания настроек проекта,
как правило, следует добавление в проект необходимых программных модулей
(функций, функциональных блоков и программ), реализация их алгоритмов и
логики работы с помощью текстовых и графических языков стандарта IEC
61131-3.

Программные модули
------------------

Добавление программных модулей (программ, функций, функциональных
блоков) осуществляется с помощью всплывающего меню дерева проекта, 
в котором необходимо выбрать пункт «Функция», «Функциональный
блок» или «Программа». Далее появится диалог «Создать новый POU».

Проект «First steps» представляет собой основной программный модуль,
написанный на языке FBD, в котором используются 5 функциональных блоков,
написанных на пяти разных языках IEC 61131-3. Каждый функциональный блок
это счетчик, увеличивающий значение выхода на единицу до тех пор, пока
на входе Reset не будет установлено значение True. Инкрементация
значения происходит в каждом цикле основной программы. Регулировать
интервал цикла можно изменяя длительность задачи для экземпляра основной
программы в панели ресурсов.

В созданный проект необходимо добавить программу program0, функцию и 5
функциональных блоков: CounterST, CounterLD, CounterFBD, CounterSFC,
CounterIL. Если при создании проекта основной программный модуль
program0 не был добавлен, его следует добавить вручную. Далее
рассмотрено добавление каждого программного модуля в отдельности.

---------
Программа
---------

Ниже будет приведён пример добавления в проект программы, написанной на
языке FBD. Логика и алгоритм работы данного программного модуля
следующие: определена переменная Reset типа BOOL, отвечающая за сброс
каждого из пяти счетчиков, определены пять переменных Cnt1..Cnt5 типа
INT, в них хранится значение каждого из пяти счетчиков, и добавлены пять
функциональных блоков, представляющих собой инкрементирующий счетчик на
пяти языках IEC 61131-3. При запуске программы начальное значение
переменной Reset устанавливается по умолчанию False. Значения счетчиков
начнут увеличиваться, начиная со значения по умолчанию (для типа INT
равно 0). Для сброса счетчиков переменную Reset необходимо форсировать
значением True, затем вернуть значение False. Переменным Cnt1..Cnt5
будет присвоено начальное значение конфигурационной константы
ResetCounterValue, таким образом значения счетчиков
сбросятся, и начнется отсчет начиная с 17.

Сначала следует добавление программы в проект, осуществляемое с помощью
меню дерева проекта, выбором пункта «Программа» (см. :numref:`image153`):

.. figure:: ./media/image153.png
   :name: image153
   :align: center
   :figclass: align-center
   :width: 2.48837in
   :height: 3.73256in

   \- Добавление программы в проект

В появившемся диалоге (см. :numref:`image154`) выберем язык FBD и тип POU
«программа».

.. figure:: ./media/image154.png
   :name: image154
   :align: center
   :figclass: align-center
   :width: 3.23958in
   :height: 2.46875in

   \- Диалог добавления программы в проект

Добавим в панели переменных и констант переменную Reset типа BOOL,
отвечающую за сброс каждого из пяти счетчиков, а так же пять переменных
Cnt1..Cnt5 типа INT, в которых будут храниться значения каждого из пяти
счетчиков. Далее необходимо обратиться к редактору языка FBD. Для
написания алгоритма и логики выполнения данной программы нам понадобятся
функциональные блоки счетчиков, создание которых рассмотрено в п. 6.3.2.

Для удобства редактирования FBD диаграмм в редакторе существует функция
Drag&Drop , необходимые функциональные блоки и
переменные можно добавить в поле редактирования из библиотеки функций и
функциональных блоков и таблицы переменных путем
перетаскивания в поле редактирования. необходимо левой
клавишей мыши зажать столбец «#» для переменной в панели переменных и
констант, далее перенести указатель на область редактирования FBD
диаграммы и отпустить кнопку мыши (Drag&Drop).

Перенесем 5 экземпляров переменной Reset и все переменные Cnt1..Cnt5 в
поле редактирования диаграммы как показано на :numref:`image155`:

.. figure:: ./media/image155.png
   :name: image155
   :align: center
   :figclass: align-center
   :width: 6.08574in
   :height: 4.35274in

   \- Перенос переменных в поле редактирования

Из библиотеки функций и функциональных блоков добавим пользовательские
функциональные блоки. Добавление данных функциональных блоков удобнее
осуществить переносом соответствующей функции с помощью мыши (Drag&Drop)
из панели библиотеки функций и функциональных блоков в область
редактирования FBD диаграммы данного программного модуля как показано 
на :numref:`image156`:

.. figure:: ./media/image156.png
   :name: image156
   :align: center
   :figclass: align-center
   :width: 6.61565in
   :height: 4.56977in

   \- Программа на языке FBD без связей

Добавим связи между функциональными блоками и входными и выходными
переменными.

.. figure:: ./media/image157.png
   :name: image157
   :align: center
   :figclass: align-center
   :width: 6.93338in
   :height: 5in

   \- Основной программный модуль на языке FBD

-------------------
Функциональный блок
-------------------

Добавление пользовательского функционального блока происходит путем
нажатия на пункт «Функциональный блок» во всплывающем меню дерева
проекта . В диалоговом окне (см. :numref:`image158`) задайте имя
функционального блока в поле «Имя POU», в поле «Тип POU» выберите
«функциональный блок», в поле «Язык» выберите язык, на котором будет
написан алгоритм работы блока.

.. figure:: ./media/image158.png
   :name: image158
   :align: center
   :figclass: align-center
   :width: 2.67442in
   :height: 2.96774in

   \- Диалог создания нового функционального блока

**Функциональный блок на языке ST**

Создайте функциональный блок с именем «CounterST» (см. :numref:`image159`), в
котором инструментами языка ST будет реализован счетчик , принимающий на
вход переменную Reset типа BOOL, и возвращающий значение счетчика Out.

.. figure:: ./media/image159.png
   :name: image159
   :align: center
   :figclass: align-center
   :width: 2.875in
   :height: 2.18167in

   \- Диалог добавления пользовательского функционального блока

В отличие от функции, функциональный блок может быть описан на любом
языке стандарта IEC 61131-3, включая язык SFC. На :numref:`image160` показана
реализация данного функционального блока на языке ST.

.. figure:: ./media/image160.png
   :name: image160
   :align: center
   :figclass: align-center
   :width: 7.27511in
   :height: 3.08333in

   \- описание пользовательского функционального блока на языке ST

Возвращаемое значение «Out» имеет тип INT и класс «Выход». Добавленные
локальная переменная «Cnt» и внешняя конфигурационная переменная
«ResetCounterValue» имеют тип INT, входная переменная «Reset» имеет тип
BOOL. Реализованный функциональный блок становится доступным в панели
библиотеки функций и функциональных блоков и может
использоваться в программных модулях типа «Программа» и «Функциональный
блок». На :numref:`image161` показано использование созданного функционального
блока «CounterST» в основном программном модуле, написанном на языке
FBD.

.. figure:: ./media/image161.png
   :name: image161
   :align: center
   :figclass: align-center
   :width: 6.70833in
   :height: 2.94044in

   \- Использование созданного функционального блока CounterST в основном программном модуле

С входом «Reset» соединена общая для всех счетчиков переменная «Reset»
типа BOOL, результат выполнения помещается в переменную «Cnt1» типа INT.
Следует отметить, что при попытке удаления функции или функционального
блока из проекта (см. :numref:`image162`), где эти добавленные программные модули
уже используются, будет выдана ошибка.

.. figure:: ./media/image162.png
   :name: image162
   :align: center
   :figclass: align-center
   :width: 2.75in
   :height: 1.4537in

   \- Сообщение об ошибке при удалении функционального блока

Реализации на других языках полностью идентичны по набору входных,
выходных и локальных переменных. Далее будут описаны примеры
функциональных блоков на остальных четырех языках IEC 61131-3.

**Функциональный блок на языке FBD**

Создайте функциональный блок с именем «CounterFBD», в котором
инструментами языка FBD будет реализован счетчик , принимающий на вход
переменную «Reset» типа BOOL, и возвращающий значение счетчика «Out».
Для удобства редактирования FBD диаграмм в редакторе существует функция
Drag&Drop , необходимые функциональные блоки и
переменные можно добавить в поле редактирования из библиотеки функций и
функциональных блоков и таблицы переменных путем
перетаскивания в поле редактирования (см. :numref:`image163`). необходимо левой
клавишей мыши зажать столбец «#» для переменной в панели переменных и
констант, далее перенести указатель на область редактирования FBD
диаграммы и отпустить кнопку мыши (Drag&Drop).

Добавим возвращаемое значение «Out» типа INT и класса «Выход», локальную
переменную «Cnt» типа INT, внешнюю конфигурационную переменную
«ResetCounterValue» типа INT, и входную переменную «Reset» типа BOOL.

.. figure:: ./media/image163.png
   :name: image163
   :align: center
   :figclass: align-center
   :width: 3.97708in
   :height: 2.63542in

   \- Добавление переменной в поле редактирования

Перенесенные на поле редактирования переменные отображаются как
прямоугольные блоки с коннекторами входа и выхода(см. :numref:`image164`).

.. figure:: ./media/image164.png
   :name: image164
   :align: center
   :figclass: align-center
   :width: 4.29167in
   :height: 1.72917in

   \- Блоки переменных в поле редактирования

После переноса в поле редактирования всех переменных, добавьте числовой
литерал со значением «1» при помощи кнопки «Создать новую
переменную», в диалоговом окне создания переменной в поле «Выражение»
напишите «1» (см. :numref:`image165_2`). Таким способом задается шаг инкрементации
счетчика.

.. figure:: ./media/image165.png
   :name: image165_2
   :align: center
   :figclass: align-center
   :width: 2.98958in
   :height: 3.05219in

   \- Диалог создания переменной

Для того чтобы переменной «Cnt» можно было одновременно и присвоить
значение и передать это значение переменной Out, задайте класс
переменной «Вход/Выход». Сделать это можно щелчком правой кнопкой мыши
по блоку переменной, во всплывающем меню следует выбрать «Вход/Выход»
(см. :numref:`image166`), или щелкнув по блоку двойным щелчком левой кнопки мыши,
выбрав в выпадающем списке «Класс» вариант «Вход/Выход»(см. :numref:`image167`).

.. figure:: ./media/image166.png
   :name: image166
   :align: center
   :figclass: align-center
   :width: 2.46875in
   :height: 1.64583in

   \- Выбор коннектора для блока переменной

.. figure:: ./media/image167.png
   :name: image167
   :align: center
   :figclass: align-center
   :width: 2.97917in
   :height: 3.06496in

   \- Диалог редактирования свойств блока переменной

Далее необходимо обратиться к редактору языка FBD. Для написания
алгоритма и логики выполнения данной программы будут добавлены две
функции: «ADD» и «SEL».

Функция «ADD» находится во вкладке «Математика» в Библиотеке функций и
функциональных блоков , обозначает сложение от 2 до 20
входных значений (в нашем примере их 2) на входах «IN1» и «IN2»,
возвращает результат вычисления на выход «OUT».

Функция «SEL» обозначает «Выбор одного из двух значений» и находится во
вкладке «Операции выбора». Она содержит три входных переменных «G»,
«IN0», «IN1» и одну выходную «OUT». Если «G» равно 0 (или FALSE), то
выходной переменной «OUT» присваивается значение «IN0». Если «G» равно 1
(или TRUE), то выходной переменной «OUT» присваивается значение «IN1».

Добавление данных функций удобнее осуществить переносом соответствующей
функции с помощью мыши (Drag&Drop) из панели Библиотеки функций и
функциональных блоков в область редактирования FBD диаграммы
функционального блока. Результатом вышеизложенных действий должна стать
FBD диаграмма без соединений (см. :numref:`image168`).

.. figure:: ./media/image168.png
   :name: image168
   :align: center
   :figclass: align-center
   :width: 4.67708in
   :height: 1.97877in

   \- FBD диаграмма без соединений

Следующим шагом станет соединение выходов переменных со входами функций.
Соединим числовой литерал 1 с входом «IN1» функции ADD, а выход «OUT»
функции ADD соединим с входом «IN0» функции SEL. В свою очередь, выход
«OUT» функции SEL соединим с входным коннектором переменной Cnt, а
выходной коннектор переменной Cnt соединим с входом переменной «Out».
Соединение блоков осуществляется путем зажатия левой кнопки мыши на
коннекторе блока, будет создана линия связи которую необходимо протянуть
до коннектора присоединяемого блока (см. :numref:`image169`).

.. figure:: ./media/image169.png
   :name: image169
   :align: center
   :figclass: align-center
   :width: 4.33333in
   :height: 2.03435in

   \- Соединение блоков в FBD диаграмме

Далее присоединим переменную «Reset», управляющую сбросом счетчика, на
вход «G» функции «SEL», а конфигурационную переменную
«ResetCounterValue» на вход «IN1». Таким образом, меняя значение
переменной «Reset» мы управляем значением переменной «Cnt» через функцию
выбора значения «SEL» . Осталось добавить связь между переменной «Cnt» и
входом «IN2» функции сложения ADD, тем самым обеспечив увеличение
значения счетчика на 1 за один цикл ПЛК.

Полученная реализация алгоритма счетчика на языке FBD представлена 
на :numref:`image170`.

.. figure:: ./media/image170.png
   :name: image170
   :align: center
   :figclass: align-center
   :width: 5.95531in
   :height: 3.46875in

   \- Функциональный блок на языке FBD

Функциональный блок становится доступным в панели библиотеки функций и
функциональных блоков и может использоваться в программных
модулях типа «Программа» и «Функциональный блок». На :numref:`image171` показано
использование созданного функционального блока «CounterFBD» в основном
программном модуле, написанном на языке FBD.

.. figure:: ./media/image171.png
   :name: image171
   :align: center
   :figclass: align-center
   :width: 7.02326in
   :height: 3.22318in

   \- Использование созданного функционального блока CounterFBD в основном программном модуле

**Функциональный блок на языке SFC**

Создайте функциональный блок с именем «CounterSFC», в котором
инструментами языка SFC будет реализован счетчик , принимающий на вход
переменную «Reset» типа BOOL, и возвращающий значение счетчика «Out».

Добавим в панель переменных и констант возвращаемое значение «Out» типа
INT и класса «Выход», локальную переменную «Cnt» типа INT, внешнюю
конфигурационную переменную «ResetCounterValue» типа INT, и входную
переменную «Reset» типа BOOL.

Для удобства редактирования SFC диаграмм в редакторе существует функция
Drag&Drop, необходимые функциональные блоки и
переменные можно добавить в поле редактирования из библиотеки функций и
функциональных блоков и таблицы переменных путем
перетаскивания в поле редактирования (см. :numref:`image163`). необходимо левой
клавишей мыши зажать столбец «#» для переменной в панели переменных и
констант, далее перенести указатель на область редактирования SFC
диаграммы и отпустить кнопку мыши (Drag&Drop).

Добавим начальный шаг диаграммы, нажав на кнопку «Создать исходный шаг»,
в диалоге изменим название шага по умолчанию на название «Start»,
коннектор потребуется только «Выход»(cм. :numref:`image172`)

.. figure:: ./media/image172.png
   :name: image172
   :align: center
   :figclass: align-center
   :width: 1.97917in
   :height: 2.25271in

   \- Добавление начального шага

Следуя алгоритму, возможны два состояния – счетчик увеличивается и
счетчик сброшен. Добавим альтернативное ветвление с двумя ветвями. 
Согласно стандарту IEC 61131-3, каждая ветвь
альтернативного ветвления должна оканчиваться переходом. Условиями
переходов будет являться состояние переменной «Reset» : для первой ветви
выражение «NOT Reset» , для второй ветви просто значения «Reset» (см.:numref:`image173`).

.. figure:: ./media/image173.png
   :name: image173
   :align: center
   :figclass: align-center
   :width: 6.38807in
   :height: 2.94584in

   \- Добавление альтернативного ветвления

В первом состоянии добавим шаг с действием «Count» (см. :numref:`image174`), в
действии на языке ST опишем увеличение счетчика на единицу, и присвоение
значения переменной «Out» (см. :numref:`image175`).

.. figure:: ./media/image174.png
   :name: image174
   :align: center
   :figclass: align-center
   :width: 2.12791in
   :height: 2.41452in

   \- Добавление шага с коннектором действия

.. figure:: ./media/image175.png
   :name: image175
   :align: center
   :figclass: align-center
   :width: 5.24419in
   :height: 3.08618in

   \- Добавление действия инкрементации счетчика

Во второй ветви добавим шаг с действием «ResetCounter», в действии
опишем присвоение переменной «Cnt» значение переменной
«ResetCounterValue», и значению «Out» значение переменной «Cnt» (см.:numref:`image176`).

.. figure:: ./media/image176.png
   :name: image176
   :align: center
   :figclass: align-center
   :width: 5.30547in
   :height: 3.0864in

   \- Добавление действия сброса счетчика

Первая ветвь отвечает за инкрементацию счетчика, вторая – за сброс (см. :numref:`image177`).

.. figure:: ./media/image177.png
   :name: image177
   :align: center
   :figclass: align-center
   :width: 5.11313in
   :height: 2.12972in

   \- Шаги с действиями

Для выходов из состояния добавим в первой ветви переход с условием
«Reset», во второй ветви добавим переход с условием «NOT Reset»(см. :numref:`image178`).

.. figure:: ./media/image178.png
   :name: image178
   :align: center
   :figclass: align-center
   :width: 5.31358in
   :height: 2.13954in

   \- Условные переходы для выхода из состояний

Далее, объединим ветви альтернативным объединением. Для того чтобы
программа выполнялась циклически, после объединения добавим безусловный
переход к начальному шагу «Start». Полученная реализация счетчика на
языке SFC представлена на :numref:`image179`.

.. figure:: ./media/image179.png
   :name: image179
   :align: center
   :figclass: align-center
   :width: 6.47331in
   :height: 4.20609in

   \- Реализация счетчика на языке SFC

Функциональный блок становится доступным в панели библиотеки функций и
функциональных блоков и может использоваться в программных
модулях типа «Программа» и «Функциональный блок». На
:numref:`image180` показано
использование созданного функционального блока «CounterSFC» в основном
программном модуле, написанном на языке FBD.

.. figure:: ./media/image180.png
   :name: image180
   :align: center
   :figclass: align-center
   :width: 6.92947in
   :height: 3.67442in

   \- Использование созданного функционального блока CounterSFC в основном программном модуле

**Функциональный блок на языке IL**

Создайте функциональный блок с именем «CounterIL», в котором
инструментами языка IL будет реализован счетчик , принимающий на вход
переменную Reset типа BOOL, и возвращающий значение счетчика Out.

Добавим в панель переменных и констант возвращаемое значение «Out» типа
INT и класса «Выход», локальную переменную «Cnt» типа INT, внешнюю
конфигурационную переменную «ResetCounterValue» типа INT, и входную
переменную «Reset» типа BOOL.

Для удобства редактирования кода в редакторе IL существует функция
Drag&Drop , необходимые переменные можно добавить в поле
редактирования из таблицы переменных путем перетаскивания в поле
редактирования (см. :numref:`image162`). необходимо левой клавишей мыши зажать
столбец «#» для переменной в панели переменных и констант, далее
перенести указатель на область редактирования и отпустить кнопку мыши
(Drag&Drop).

Напишем инструкции для сброса счетчика и сохранения результатов.
Инструкцию для сброса счетчика назовем «ResetCnt», она загрузит операнд
ResetCounterValue в аккумулятор:

.. code-block:: none

	ResetCnt:
	(\* reset counter \*)
	LD ResetCounterValue

Инструкцию для сохранения результатов назовем «QuitFb», она будет
сохранять значения операндов «Cnt» и «Out»:

.. code-block:: none

	QuitFb:
	(\* save results \*)
	ST Cnt
	ST Out

Загрузим в аккумулятор значение операнда «Reset». Если значение операнда
«True», следует перейти к инструкции сброса счетчика ResetCnt, в случае
значения «False» значение операнда должно увеличиться на единицу.

.. code-block:: none

	LD Reset
	JMPC ResetCnt
	(\* increment counter \*)
	LD Cnt
	ADD 1
	JMP QuitFb
	ResetCnt:
	(\* reset counter \*)
	LD ResetCounterValue
	QuitFb:
	(\* save results \*)
	ST Cnt
	ST Out

Полученная реализация счетчика на языке IL представлена на :numref:`image181`.

.. figure:: ./media/image181.png
   :name: image181
   :align: center
   :figclass: align-center
   :width: 6.64388in
   :height: 4.2142in

   \- Реализация счетчика на языке IL

Функциональный блок становится доступным в панели библиотеки функций и
функциональных блоков  и может использоваться в программных
модулях типа «Программа» и «Функциональный блок». На :numref:`image182` показано
использование созданного функционального блока «CounterIL» в основном
программном модуле, написанном на языке FBD.

.. figure:: ./media/image182.png
   :name: image182
   :align: center
   :figclass: align-center
   :width: 6.44621in
   :height: 4.75469in

   \- Использование функционального блока CounterIL в основном программном модуле

**Функциональный блок на языке LD**

Создайте функциональный блок с именем «CounterLD», в котором
инструментами языка LD будет реализован счетчик , принимающий на вход
переменную «Reset» типа BOOL, и возвращающий значение счетчика «Out».

Добавим в панель переменных и констант возвращаемое значение «Out» типа
INT и класса «Выход», локальную переменную «Cnt» типа INT, внешнюю
конфигурационную переменную «ResetCounterValue» типа INT, и входную
переменную «Reset» типа BOOL.

Для удобства редактирования LD диаграмм в редакторе существует функция
Drag&Drop , необходимые функциональные блоки и
переменные можно добавить в поле редактирования из библиотеки функций и
функциональных блоков  и таблицы переменных путем
перетаскивания в поле редактирования (см. :numref:`image163`). необходимо левой
клавишей мыши зажать столбец «#» для переменной в панели переменных и
констант, далее перенести указатель на область редактирования LD
диаграммы и отпустить кнопку мыши (Drag&Drop).

Добавим шину питания, к ней присоединим контакт, связанный с переменной
«Reset» (см. :numref:`image183`).

.. figure:: ./media/image183.png
   :name: image183
   :align: center
   :figclass: align-center
   :width: 3.34884in
   :height: 2.83296in

   \- Диалог добавления контакта

Полученная конструкция будет подавать сигнал на сброс счетчика при
переходе значения переменной «Reset» в True (см. :numref:`image184`)

.. figure:: ./media/image184.png
   :name: image184
   :align: center
   :figclass: align-center
   :width: 1.38542in
   :height: 0.77083in

   \- Контакт ассоциированный с переменной Reset

Далее добавим числовой литерал со значением «1» при
помощи кнопки «Создать новую переменную», в диалоговом окне создания
переменной в поле «Выражение» напишите «1» (см. :numref:`image165`). Таким способом
задается шаг инкрементации счетчика.

.. figure:: ./media/image165.png
   :name: image165
   :align: center
   :figclass: align-center
   :width: 2.98958in
   :height: 3.05219in

   \- Диалог создания переменной

Перенесенные на поле редактирования переменные отображаются как
прямоугольные блоки с коннекторами входа и выхода(см. :numref:`image185`).

.. figure:: ./media/image185.png
   :name: image185
   :align: center
   :figclass: align-center
   :width: 4.55208in
   :height: 1.95833in

   \- Блоки переменных в поле редактирования

Для того чтобы переменной «Cnt» можно было одновременно и присвоить
значение и передать это значение переменной Out, задайте класс
переменной «Вход/Выход». Сделать это можно щелчком правой кнопкой мыши
по блоку переменной, во всплывающем меню следует выбрать «Вход/Выход»
(см. :numref:`image166_2`), или щелкнув по блоку двойным щелчком левой кнопки мыши,
выбрав в выпадающем списке «Класс» вариант «Вход/Выход»(см. :numref:`image167_2`).

.. figure:: ./media/image166.png
   :name: image166_2
   :align: center
   :figclass: align-center
   :width: 2.46875in
   :height: 1.64583in

   \- Выбор коннектора для блока переменной

.. figure:: ./media/image167.png
   :name: image167_2
   :align: center
   :figclass: align-center
   :width: 2.97917in
   :height: 3.06496in

   \- Диалог редактирования свойств блока переменной

Для написания алгоритма и логики выполнения данной программы будут
добавлены две функции: «ADD» и «SEL».

Функция «ADD» находится во вкладке «Математика» в Библиотеке функций и
функциональных блоков, и обозначает сложение от 2 до 20
входных значений (в нашем примере их 2) на входах «IN1» и «IN2»,
возвращает результат вычисления на выход «OUT».

Функция «SEL» обозначает «Выбор одного из двух значений» и находится во
вкладке «Операции выбора». Она содержит три входных переменных «G»,
«IN0», «IN1» и одну выходную «OUT». Если «G» равно 0 (или FALSE), то
выходной переменной «OUT» присваивается значение «IN0». Если «G» равно 1
(или TRUE), то выходной переменной «OUT» присваивается значение «IN1».

Добавление данных функций удобнее осуществить переносом соответствующей
функции с помощью мыши (Drag&Drop) из панели Библиотеки функций и
функциональных блоков в область редактирования FBD диаграммы
функционального блока. Результатом вышеизложенных действий должна стать
LD диаграмма без соединений.

.. figure:: ./media/image186.png
   :name: image186
   :align: center
   :figclass: align-center
   :width: 4.95664in
   :height: 2.3903in

   \- LD диаграмма без соединений

Следующим шагом станет соединение выходов переменных со входами функций.
Соединим числовой литерал 1 с входом «IN1» функции ADD, а выход «OUT»
функции ADD соединим с входом «IN0» функции SEL. В свою очередь, выход
«OUT» функции SEL соединим с входным коннектором переменной Cnt, а
выходной коннектор переменной Cnt соединим с входом переменной «Out».
Соединение блоков осуществляется путем зажатия левой кнопки мыши на
коннекторе блока, будет создана линия связи которую необходимо протянуть
до коннектора присоединяемого блока .

.. figure:: ./media/image187.png
   :name: image187
   :align: center
   :figclass: align-center
   :width: 5.08261in
   :height: 2.47501in

   \- Соединение блоков

Далее присоединим сигнал с контакта, ассоциированного с переменной
«Reset», управляющей сбросом счетчика, на вход «G» функции «SEL», а
конфигурационную переменную «ResetCounterValue» на вход «IN1». Таким
образом, меняя значение переменной «Reset» мы управляем значением
переменной «Cnt» через функцию выбора значения «SEL» . Осталось добавить
связь между переменной «Cnt» и входом «IN2» функции сложения ADD, тем
самым обеспечив увеличение значения счетчика на 1 за один цикл ПЛК.

Полученная реализация алгоритма счетчика на языке LD представлена 
на :numref:`image188`.

.. figure:: ./media/image188.png
   :name: image188
   :align: center
   :figclass: align-center
   :width: 6.91132in
   :height: 4.22355in

   \- Функциональный блок на языке LD

Функциональный блок становится доступным в панели библиотеки функций и
функциональных блоков и может использоваться в программных
модулях типа «Программа» и «Функциональный блок». На рис. 146 показано
использование созданного функционального блока «CounterFBD» в основном
программном модуле, написанном на языке FBD.

.. figure:: ./media/image189.png
   :name: image189
   :align: center
   :figclass: align-center
   :width: 7.03923in
   :height: 4.89552in

   \- Использование функционального блока на языке LD в основном программном модуле

Функция

Добавление пользовательской функционального блока происходит путем
нажатия на пункт «Функция» во всплывающем меню дерева проекта. 
В диалоговом окне задайте имя функции в поле
«Имя POU», в поле «Тип POU» выберите «функция», в поле «Язык» выберите
язык, на котором будет написан алгоритм работы функции.

.. figure:: ./media/image190.png
   :name: image190
   :align: center
   :figclass: align-center
   :width: 3.11275in
   :height: 2.37209in

   \- Диалог создания функции

Создадим функцию «AverageVal» на языке ST, которая будет вычислять
среднее значение счетчиков в цикле. Поскольку счетчики никак не
синхронизированы, среднее значение должно быть дробным. Выберем тип
возвращаемого значения функции – для дробного значения это тип REAL.

.. figure:: ./media/image191.png
   :name: image191
   :align: center
   :figclass: align-center
   :width: 2.92288in
   :height: 3.7907in

   \- Выбор типа возвращаемого значения функции

В панели редактирования переменных и констант добавим пять переменных
«Cnt1»..«Cnt5» типа INT, класса «Вход». К этим входам будут подключены
выходные значения функциональных блоков, рассмотреных выше.
Добавим переменную «InputsNumber» типа REAL, класса «Локальный».

Далее в редакторе языка ST пишется алгоритм и логика работы данной
функции, как показано на рис. 149:

.. figure:: ./media/image192.png
   :name: image192
   :align: center
   :figclass: align-center
   :width: 6.63225in
   :height: 2.98798in

   \- Определение алгоритма и логики выполнения функции

Для приведения типа INT к типу REAL воспользуемся функцией INT_TO_REAL
из библиотеки функций и функциональных блоков, она преобразует значение
типа INT на входе IN в значение типа REAL на выходе OUT (INT:IN)
=>(REAL:OUT).

Добавим функцию в основной программный модуль. На панели библиотеки
функций и функциональных блоков в разделе «Пользовательские POU»
необходимо выбрать функцию «AverageVal» и с помощью указателя мыши
(зажав левую кнопку мыши) перенести данную функцию (Drag&Drop) в область
редактирования FBD диаграммы программного модуля «program0».

.. figure:: ./media/image193.png
   :name: image193
   :align: center
   :figclass: align-center
   :width: 5.83721in
   :height: 2.12601in

   \- Добавление на FBD диаграмму пользовательской функции

Подключим к входам функции значения пяти счетчиков. Для сохранения
результата вычисления функции создадим переменную «AVCnt». На :numref:`image194`
показано использование созданной функции «AverageVal» в основном
программном модуле, написанном на языке FBD.

.. figure:: ./media/image194.png
   :name: image194
   :align: center
   :figclass: align-center
   :width: 6.30667in
   :height: 4.30564in

   \- Использование функции в основном программном модуле

Ресурс
------

Согласно стандарту IEC 61131-3, каждый проект должен иметь как минимум
один ресурс, с определённым в нём как минимум одним экземпляром.
Экземпляр представляет собой элемент, связанный с программным модулем
типа «Программа» и одной определённой задачей. По умолчанию,
инструментальная среда разработки Beremiz создаёт для нового проекта
один ресурс.

-----------------------------
Глобальные переменные ресурса
-----------------------------

Глобальные переменные ресурса объявляются аналогично глобальным
переменным проекта на панели переменных и констан 
выбранного ресурса с использованием кнопки «Добавить
переменную», либо «Добавить переменные» (см. таблицу 3).

.. figure:: ./media/image195.png
   :name: image195
   :align: center
   :figclass: align-center
   :width: 7.06977in
   :height: 1.54159in

   \- Пример объявления в проекте глобальной переменной

Использование данных глобальных переменных на уровне ресурса также
аналогично использованию конфигурационных переменных проекта в
программных модулях. Для использования в программном модуле глобальной
переменной ресурса, добавьте в модуль переменную класса «Внешняя» с
таким же именем, как у глобальной переменной, объявленные выше для
ресурса.

---------------------------
Задачи и экземпляры ресурса
---------------------------

Для создания экземпляра необходимо наличие как минимум одного
программного модуля типа «Программа» в проекте и как минимум одной
задачи, определённой в панели редактирования ресурса.

После добавления задачи с помощью кнопки «Добавить» (данная кнопка
аналогична кнопки «Добавить» на панели переменных и констант),
необходимо задать её уникальное имя (поле «Имя») и выбрать тип
выполнения задачи (поле «Запуск», см. :numref:`image196`):

-  «Циклический» – выполнение программного модуля типа «Программа» через
   заданный интервал времени, указанный в поле «Интервал»;

-  «Прерывание» – выполнение программного модуля типа «Программа» один
   раз при наступлении значения TRUE глобальной переменной типа BOOL,
   определённой на уровне проекта, либо на уровне ресурса, указанной в
   поле «Источник».

.. figure:: ./media/image196.png
   :name: image196
   :align: center
   :figclass: align-center
   :width: 6.301in
   :height: 1.68605in

   \- Выбор типа выполнения задачи

В случае выбора типа выполнения «Цикличное», в поле «Интервал»
необходимо указать интервал, с которым будет выполняться данная задача.
Двойной щелчок левой кнопкой мыши по полю «Интервал» приводит к
появлению кнопки «...».

.. figure:: ./media/image197.png
   :name: image197
   :align: center
   :figclass: align-center
   :width: 6.25436in
   :height: 0.97545in

   \- Добавление задачи с цикличным режимом выполнения

Нажатие данной кнопки вызывает диалог «Редактировать продолжительность» 
в котором можно указать время, используя микросекунды,
миллисекунды, секунды, минуты, часы и дни.

.. figure:: ./media/image198.png
   :name: image198
   :align: center
   :figclass: align-center
   :width: 6.23382in
   :height: 1.58348in

   \- Диалог редактирования длительности задачи

Завершение ввода времени кнопкой «OK» приводит к закрытию диалога и
добавлению данного интервала времени в поле «Интервал» добавляемой
задачи.

.. figure:: ./media/image199.png
   :name: image199
   :align: center
   :figclass: align-center
   :width: 6.84375in
   :height: 1in

   \- Добавленный итервал выполнения

В случае выбора типа выполнения «Прерывание» в поле «Источник»
необходимо указать переменную типа BOOL, определённую глобально либо на
уровне проекта, либо на уровне ресурса. 
На :numref:`image200` выбирается переменная «globalFlag», определённая в данном
ресурсе.

.. figure:: ./media/image200.png
   :name: image200
   :align: center
   :figclass: align-center
   :width: 6.84375in
   :height: 1.79167in

   \- Выбор переменной типа BOOL как источника прерывания для начала выполнения задачи

Задача будет выполнена один раз, как только значение переменной,
определённой в этом поле, будет TRUE. Поле «Приоритет» позволяет указать
приоритет выполнения задачи, по умолчанию все задачи имеют приоритет 0.
Следует отметить, что в ресурсе должна быть определена как минимум одна
задача с типом выполнения «Цикличное», в противном случае будет ошибка в
компиляции в отладочной консоли . После того как задачи
определены, их можно использовать в экземплярах. Создание экземпляра
происходит аналогичным образом с помощью кнопки «Добавить». Необходимо
выбрать уникальное имя экземпляра и далее указать программный модуль
типа «Программа» в поле «Тип» и одну из задач в поле «Задача». Например,
в проекте определено два программных модуля типа «Программа»: «program0»
и «program1».

.. figure:: ./media/image201.png
   :name: image201
   :align: center
   :figclass: align-center
   :width: 3.04167in
   :height: 1.64583in

   \- Проект, содержащий два программных модуля типа "Программа"

Соответственно, при создании экземпляра в поле «Тип» оба этих
программных модуля будут доступны (см. рис. 159).

.. figure:: ./media/image202.png
   :name: image202
   :align: center
   :figclass: align-center
   :width: 5.97382in
   :height: 3.9311in

   \- Выбор программного модуля типа "Программа" для экземпляра

Аналогичным образом выбирается задача из списка, в котором будут
отображены определённые ранее задачи.

.. figure:: ./media/image203.png
   :name: image203
   :align: center
   :figclass: align-center
   :width: 5.95507in
   :height: 3.87351in

   \- Выбор задачи для экземпляра

В каждом проекте в ресурсе должен быть определен как минимум один
экземпляр, в противном случае будет ошибка выдана компиляции в
отладочной консоли.

Типы данных
-----------

Добавление типа данных происходит выбором пункта «Типа данных» в меню
дерева проекта (см. :numref:`image204`) в уже созданный проект, содержащий
программный модуль типа «Программа» – «program0».

.. figure:: ./media/image204.png
   :name: image204
   :align: center
   :figclass: align-center
   :width: 2.5in
   :height: 4.73958in

   \- Выбор пункта меню добавления пользовательского типа данных в дереве проекта

Будет создан массив типа INT размерностью 11 элементов. В дереве проекта
появится панель редактирования добавленного типа данных с именем
«datatype0». В поле «Механизм создания нового типа»
необходимо выбрать «Массив» и указать тип INT, как показано на :numref:`image205`:

.. figure:: ./media/image205.png
   :name: image205
   :align: center
   :figclass: align-center
   :width: 7.16713in
   :height: 3.76468in

   \- Выбор базового типа для массива

С помощью кнопки «Добавить» (см. таблицу 10) создаётся поле для массива
с указанием его размерности в соответствующем формате.

.. figure:: ./media/image206.png
   :name: image206
   :align: center
   :figclass: align-center
   :width: 6.99974in
   :height: 2.77907in

   \- Задание размерности для массива

После выполнения вышеперечисленных операций тип «datatype0» может быть
использован для определения переменных в программных модулях, так же как
и базовые типы данных.

.. figure:: ./media/image207.png
   :name: image207
   :align: center
   :figclass: align-center
   :width: 6.70202in
   :height: 2.01872in

   \- Выбор добавленного типа данных в панели переменных и констант программного модуля

Сборка и передача на целевое устройство прикладной программы
------------------------------------------------------------

Следующими шагами после создания основных элементов проекта является его
сборка (компиляция и компоновка), передача полученного исполняемого
файла на целевое устройство и отладка данной прикладной программы.

Сборка проекта осуществляется с помощью соответствующих кнопок,
находящихся на панели инструментов . Для успешного
завершения данной операции каждый проект должен иметь как минимум один
ресурс (как уже упоминалось, при создании проекта по умолчанию ресурс
будет создан). В ресурсе должна быть определена, как минимум, одна
задача циклического типа и, как минимум, один экземпляр. Соответственно,
проект обязан содержать, как минимум, один программный модуль типа
«Программа», причём тело, т.е. алгоритм и логика его выполнения, не
может быть пустым (в противном случае будет ошибка компиляции).

Возможность передачи на целевое устройство прикладной программы и её
отладки определяется наличием запущенной на целевом устройстве серверной
части среды разработки Beremiz.

Среда разработки Beremiz предоставляет следующие возможности отладки:

-  Просмотр и изменение значения всех переменных проекта, используя
   панель отладки;

-  Визуально отслеживание выполнения программ на графических языках и
   изменение значения различных графических элементов конкретного языка;

-  Отображение значений переменных в виде графика.

Далее подробнее рассказывается про сборку прикладной программы,
соединение с целевым устройством и передачу на него исполняемого файла и
его отладке.

---------------------------
Сборка прикладной программы
---------------------------

Прежде чем проект будет передан ПЛК, его необходимо собрать. Настроить
целевую платформу для сборки можно в окне настройки проекта, 
на вкладке Конфигурация.

Для сборки проекта нажмите кнопку «Сборка проекта в директории сборки»
(см. табл. 2). Результаты сборки
выводятся в консоль, расположенную в нижней части окна программы, ошибки
сборки выделяются красным цветом. На примере проекта First_steps после
сборки в консоль выведено сообщение о том, что сборка проведена успешно.

.. figure:: ./media/image209.png
   :name: image209
   :align: center
   :figclass: align-center
   :width: 7.1039in
   :height: 2.3393in

   \- Результаты сборки выведены в консоль

Пересборку проекта можно осуществить, очистив директорию сборки проекта
нажатием на кнопку «Очистить директорию сборки проекта» (см. табл.2).
Будет удален сгенерированный на языке ST код проекта и скомпилированный
бинарный файл прошивки ПЛК. После этого нажмите кнопку «Сборка проекта в
директории сборки», и проект будет собран заново.

----------------------------------
Запуск серверной части для отладки
----------------------------------

Серверная часть среды разработки Beremiz, необходимая для передачи
исполняемого файла на целевое устройство и его отладки, находится в
сценарии на языке Python в файле Beremiz_service.py. Запуск данного
файла осуществляется из командной строки, следующей командой с
параметрами по умолчанию (см. таблицу 13):

$ python Beremiz_service.py

Также, при запуске могут быть указаны параметры, представленные в
таблице 13.

Таблица 13 - Параметры командной строки запуска серверной части среды
Beremiz

+----------+-----------------------------------------------------------------------------+
| Параметр | Операция                                                                    |
+==========+=============================================================================+
| -i       | Указание IP адреса для обращения клиента,                                   |
|          | по умолчанию 127.0.0.1 (localhost)                                          |
+----------+-----------------------------------------------------------------------------+
| -p       | Номер порта, по умолчанию 3000                                              |
+----------+-----------------------------------------------------------------------------+
| -h       | Вывод в консоль справки по работе с данным сервером                         |
+----------+-----------------------------------------------------------------------------+
| -a       | Автоматический запуск целевого устройства (0 – выключить, 1 – включить),    |
|          | по умолчанию 0.                                                             |
+----------+-----------------------------------------------------------------------------+
| -x       | Включить/выключить иконку в панели задач (0 – выключить,1 – включить),      |
|          | по умолчанию 0.                                                             |
+----------+-----------------------------------------------------------------------------+
| -t       | Web-интерфейс на базе библиотеки Twisted (0 – выключить, 1 – включить),     |
|          | по умолчанию 0.                                                             |
|          | Он позволяет отслеживать состояние выполнения программы через браузер.      |
|          | Адрес: \http://<ip-адрес целевого устройства>:<8009>.                       |
|          | 8009 – порт по умолчанию.                                                   |
+----------+-----------------------------------------------------------------------------+

После указания всех параметров команды запуска серверной части Beremiz
можно ввести адрес директории, в которой будут храниться файлы на
файловой системе целевого устройства. По умолчанию этой директорией
является временная папка, созданная для текущего запущенного экземпляра
службы Beremiz_service.

Как правило, данный сценарий запускается в автоматическом режиме при
включении целевого устройства, средствами операционной системы.

Соединение с целевым устройством и передача исполняемого файла

После того как скрипт серверной части среды разработки Beremiz запущен,
можно производить соединение с целевым устройством. В панели настроек
проекта необходимо указать URI-адрес целевого устройства:

PYRO://<IP-адрес>:<номер порт>

На :numref:`image210` показан URI адрес целевого устройства LOCAL://,это адрес
Soft PLC на локальной машине, и выделена красным цветом кнопка
«Покдлючиться к целевому ПЛК» (см. таблицу 2), которая используется для
соединения с целевым устройством.

.. figure:: ./media/image210.png
   :name: image210
   :align: center
   :figclass: align-center
   :width: 4.56977in
   :height: 5.20008in

   \- Соединение с целевым устройством

В случае успешного соединения, в отладочной консоли будет выведено
соответствующее сообщение и выведен статус прикладной программы.

.. figure:: ./media/image211.png
   :name: image211
   :align: center
   :figclass: align-center
   :width: 6.16883in
   :height: 1.73122in

   \- Отладочная консоль после соединения с целевым устройством

Статусы прикладной программы могут быть следующие:

-  «PLC Empty» – прикладная программа отсутствует;

-  «PLC Started» – прикладная программа на целевом устройстве есть и она
   выполняется;

-  «PLC Stopped» – прикладная программа на целевом устройстве есть, но
   остановлена.

Используя кнопки передачи, запуска и остановки прикладной программы на
целевом устройстве (см. таблицу 2) можно передать исполняемый файл
прикладной программы, запустить его и остановить. В отладочной консоли
будут выведены соответствующие сообщения (после передачи, запуска и
остановки прикладной программы), как показано на :numref:`image212`:

.. figure:: ./media/image212.png
   :name: image212
   :align: center
   :figclass: align-center
   :width: 6.80786in
   :height: 3.87209in

   \- Отладочная консоль после передачи прикладной программы, запуска и остановки

Отладка прикладной программы
----------------------------

После установки соединения с целевым устройством и запуском прикладной
программы на выполнение, среда разработки Beremiz позволяет отслеживать
и изменять значения переменных программных модулей, из которых состоит
проект.

----------------------------------------
Retain переменные в прикладной программе
----------------------------------------

В SoftPLC реализована поддержка переменных, для которых в прикладной
программе определено свойство реманентности (Retain-переменные). При
подключении к серверной части среды разработки Beremiz, создается
временная папка для хранения прикладной программы, загружаемой в
SoftPLC, Retain переменные хранятся в этой временной папке в виде
бинарного файла, содержащего в себе хеш-сумму проекта, значения Retain
переменных в бинарном формате, и контрольную сумму файла, вычисляемую по
алгоритму CRC32.

----------------
Запуск отладчика
----------------

Осуществив передачу скомпилированной программы на SoftPLC, запустите
отладку, нажав кнопку «Запустить ПЛК» (см. табл. 2). 
Переменные принимают исходные значения, затем
начинается исполнение программы в ПЛК. Отладчик запущен.

------------------------
Отладка текстовых языков
------------------------

Работа с отладчиком подразумевает работу с экземпляром загруженной в ПЛК
программы. Функциональные блоки, функции и переменные тоже имеют свои
экземпляры, доступные для отладки только после того как программа будет
запущена на исполнение. В левом нижнем углу основного окна среды
разработки расположена панель экземпляров проекта. 
В адресной строке написан адрес ресурса, для которого ниже отображены
экземпляры программ, глобальных переменных и функциональных блоков
определенных в данном ресурсе.

.. figure:: ./media/image214.png
   :name: image214
   :align: center
   :figclass: align-center
   :width: 2.66539in
   :height: 3.96512in

   \- Панель экземпляров проекта

Переход к родительскому экземпляру и его глобальным переменным
осуществляется кнопкой «Родительский экземпляр»(см. табл. 11).

Кнопка «Отладка экземпляра» (см. табл. 11) напротив адресной строки в
верхней части панели запустит отладку выбранного ресурса(программы или
функционального блока). Для того чтобы включить отладку экземпляра блока
или переменной, нажмите кнопку напротив этого элемента на панели. На
панели отладки отобразятся текущие значения добавленных переменных.

.. figure:: ./media/image215.png
   :name: image215
   :align: center
   :figclass: align-center
   :width: 2.3704in
   :height: 2.70903in

   \- Панель отладчика

После того как переменная выведена на панель отладки, для того чтобы
установить значение нажмите кнопку «Форсировать значение».

.. figure:: ./media/image216.png
   :name: image216
   :align: center
   :figclass: align-center
   :width: 2.40625in
   :height: 2.75in

   \- Форсирование переменной в панели отладки

В появившемся диалоге введите значение переменной (см. :numref:`image217`). Для
булевых переменных в диалоге присутствует кнопка «Переключить значение»,
которая меняет значение переменной на противоположное. После изменения
значения переменной, она будет выделена синим цветом в таблице
переменных и их значений во вкладке «Отладчик».

.. figure:: ./media/image217.png
   :name: image217
   :align: center
   :figclass: align-center
   :width: 3.46875in
   :height: 1.82292in

   \- Диалог установки значения

Форсируя значение переменной, вы устанавливаете неизменяемое значение,
переопределение которого выполняемой программой будет невозможно. После
установки значения, его можно освободить, дав возможность программе
изменять значение переменной. Для освобождения переменной нажмите кнопку
«Освободить значение».

.. figure:: ./media/image218.png
   :name: image218
   :align: center
   :figclass: align-center
   :width: 2.1706in
   :height: 2.37209in

   \- Освобождение значения переменной

Для корректного изменения, вводимое значение должно соответствовать типу
переменной, иначе будет выведено сообщение об ошибке, как показано 
на :numref:`image219`:

.. figure:: ./media/image219.png
   :name: image219
   :align: center
   :figclass: align-center
   :width: 4.26042in
   :height: 1.61458in

   \- Ошибка при вводе недопустимого значения изменяемой переменной в режиме отладки

--------------------------
Отладка графических языков
--------------------------

Во время отладки прикладной программы, в которой часть программных
модулей написаны на графических языках, есть возможность видеть
изменения всех значений на диаграмме и вносить необходимые изменения
прямо на ней. Как уже упоминалось ранее, в случае нажатия
кнопки запуска режима отладки (на :numref:`image220` выделены красным цветом) для
экземпляра программы, написанной на одном из графических языков,
откроется вкладка с панелью диаграммы в режиме отладки.

.. figure:: ./media/image220.png
   :name: image220
   :align: center
   :figclass: align-center
   :width: 2.51163in
   :height: 3.73638in

   \- Панель экземпляров проекта

Эти вкладки полностью повторяют те, в которых графические диаграммы
программ или функциональных блоков редактируются, за исключением того
что во вкладках отладчика невозможно внести какие-либо изменения, а
связи между элементами выделяются разным цветом в зависимости от
значения переменной, передаваемого по этой связи.

.. figure:: ./media/image221.png
   :name: image221
   :align: center
   :figclass: align-center
   :width: 5.70857in
   :height: 3.47361in

   \- Пример отлаживаемой FBD диаграммы

Линии, не выделенные цветом передают либо булевое значение False, либо
переменную не булевого типа (INT, DINT, WORD, REAL, TIME, и т.д.).
Оранжевого цвета связи, передающие константное выражение. Светло-зелёным
цветом выделены связи, которые передают булевое значение True. Связи,
выделенные светло-голубым и тёмно-синим цветом передают значения
непосредственно установленные пользователем, значение
True соответствует светло-голубому цвету, False - тёмно-синему.

**Отладка FBD диаграммы**

В режиме отладки FBD диаграммы есть возможность устанавливать входные и
выходные значения переменных (с помощью всплывающего меню, которые
вызывается нажатием правой клавишей по соединению) для функциональных
блоков, а также в целом видеть все остальные значения на входах и
выходах элементов диаграммы.

.. figure:: ./media/image222.png
   :name: image222
   :align: center
   :figclass: align-center
   :width: 5.80233in
   :height: 2.88211in

   \- Отладка FBD диаграммы

Изменённые значения в режиме отладки выделяются синим цветом. После
выбора во всплывающем меню «Освободить значение» значение возвращается в
то, которое получается в результате выполнения логики и алгоритма
данного модуля на данном участке, а соединение на диаграмме становятся
исходного цвета.

**Отладка LD диаграммы**

Отладка LD диаграммы осуществляется аналогично отладке FBD диаграммы.
Для вызова всплывающего меню (см. рис. 196), в котором можно установить
желаемое значение для контакта или катушки необходимо нажать правую
клавишу мыши.

.. figure:: ./media/image223.png
   :name: image223
   :align: center
   :figclass: align-center
   :width: 5.23329in
   :height: 2.38763in

   \- Пример отладки LD диаграммы

Появится диалог (см. :numref:`image224`), в котором нужно ввести значение типа
BOOL: TRUE–контакт «ON», FALSE – контакт «OFF».

.. figure:: ./media/image224.png
   :name: image224
   :align: center
   :figclass: align-center
   :width: 3.30233in
   :height: 2.02464in

   \- Диалог переключения состояния контакта

**Отладка SFC диаграммы**

Отладка SFC диаграммы происходит аналогично отладке диаграмм FBD и LD. С
помощью всплывающего меню (см. :numref:`image225`), есть возможность устанавливать
активность для шагов и переходов.

.. figure:: ./media/image225.png
   :name: image225
   :align: center
   :figclass: align-center
   :width: 5.76744in
   :height: 3.26981in

   \- Пример отладки SFC диаграммы

На :numref:`image226` показано, как устанавливается значение (после выбора
«Форсировать значение», появится диалог) TRUE для шага «ResetCounter».

.. figure:: ./media/image226.png
   :name: image226
   :align: center
   :figclass: align-center
   :width: 5.80225in
   :height: 3.28954in

   \- Изменение состояния шага "ResetCounter"

После установки значения шага в TRUE с помощью режима отладки, шаг будет
выделен голубым цветом. Как можно заметить по :numref:`image227`, т.к. шаг
«ResetCounter» стал активным, блок действий, ассоциированный с ним, так
же стал активным (выделен зелёным цветом), а действия внутри него, в
данном случае присвоение переменной «Cnt» значения конфигурационной
переменной «ResetCounterValue», а переменной «Out» значения переменной
«Cnt»:

Cnt := ResetCounterValue;

Out := Cnt;

стало выполняться.

.. figure:: ./media/image227.png
   :name: image227
   :align: center
   :figclass: align-center
   :width: 5.95349in
   :height: 3.34762in

   \- Форсирование блока действия

Так как квалификатор этого действия – N, то оно будет выполняться до тех
пор, пока шаг активен.

График изменения значений переменной

Среда разработки Beremiz так же позволяет отображать в виде графика
изменение значения переменной в режиме отладки. Для вывода панели с
графиком, необходимо два раза кликнуть левой кнопкой мыши по кнопке
«Отладка экземпляра» напротив переменной в панели экземпляров проекта.

Появившееся панель графика изменения переменной позволяет
отслеживать то, как значение определённой переменной изменяется в
течение времени.

.. figure:: ./media/image228.png
   :name: image228
   :align: center
   :figclass: align-center
   :width: 5.03602in
   :height: 5.43023in

   \- График изменения переменных

На данной панели можно установить интервал обновления и масштаб
отображения графика, а так же передвигать позицию графика.

